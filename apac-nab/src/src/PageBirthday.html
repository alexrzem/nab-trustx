<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Birthday</title>
  <!-- Importing Material Components Web -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Epilogue:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:ital,wght@0,200..900;1,200..900&display=swap"
    rel="stylesheet">
  <script type="importmap">
      {
        "imports": {
          "@material/web/": "https://esm.run/@material/web/"
        }
      }
    </script>
  <script type="module">
    import "@material/web/all.js";
    import { styles as typescaleStyles } from "@material/web/typography/md-typescale-styles.js";

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
  </script>
  <script type="text/javascript" src="./assets/js/moments.js"></script>
  <!-- <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" /> -->
  <link rel="stylesheet" href="./assets/css/main.css" />
  <link rel="stylesheet" href="./assets/css/sheet.css" />
  <link rel="stylesheet" href="./assets/css/pikaday.css" />
  <link rel="stylesheet" href="./assets/css/progress-expand.css" />
</head>

<body id="overlay" onload="subscribeToTrustX();">
  <div class="container" style="flex: 1;">
    <div class="container-top">
      <div class="container-top-navigation">
        <md-text-button id="back-button" onclick="dispatchBack()" style="visibility: hidden;">
          <i class="material-icons">arrow_back</i>
        </md-text-button>
        <div id="navigation-parent" style="position: relative; visibility: hidden;">
          <md-text-button id="progress-expand-anchor">
            <i class="material-icons right">checklist_rtl</i>
          </md-text-button>
        </div>
      </div>
    </div>

    <div class="container-content">
      <form class="form-container">
        <div class="container-body">
          <div class="container-input-header">
            <h1>When is your birthday?</h1>
            <p style="margin-bottom: 24px;">Enter your date of birth.</p>
          </div>
          <div class="container-input-section">
            <md-outlined-text-field class="input-text" id="documentDateOfBirth" label="Date of birth" type="text"
            supporting-text="Enter or select a date or enter in the DD/MM/YYYY format." data-trustx-map-date="true"
            inputmode="text" style="margin-top: 0">
            <md-icon class="material-icons btn-calendar" slot="trailing-icon" role="button" id="btn-dob">event</md-icon>
          </md-outlined-text-field>
          </div>
        </div>
      </form>
    </div>

    <div class="container-bottom">
      <div>
        <md-filled-button id="next-button" class="next-button" onclick="validateAndDispatchData()">Next</md-filled-button>
      </div>
    </div>
  </div>


  <script>
    const currentPage = 'PageBirthday'
  </script>
  <!-- Importing Material Components Web JS -->
  <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
  <script type="text/javascript" src="./assets/js/pikaday.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script type="text/javascript" src="./assets/js/main.js"></script>
  <script type="text/javascript" src="./assets/js/trustx.js"></script>
  <script type="text/javascript" src="./assets/js/error.js"></script>
  <script type="text/javascript" src="./assets/js/validation.js"></script>
  <script type="text/javascript" src="./assets/js/common.js"></script>
  <script type="text/javascript" src="./assets/js/sheet.js"></script>

  <script>
    enableEnterKeyOnButtonId('next-button');
  </script>
  <script>
    let isOverEighteenFlag = false
    let totalAttempt = 0

    analyticsSectionName = "what-is-your-birthday?"

    processCallback = (sessionData, constants) => {
      isOverEighteenFlag = sessionData?.isOverEighteen
      totalAttempt = sessionData?.idv?.totalAttempt ?? 0
    }

    const thisYear = new Date().getFullYear()
    const dobPicker = new Pikaday({
      field: document.getElementById("documentDateOfBirth"),
      format: "DD/MM/YYYY",
      yearRange: [1900, thisYear],
      maxDate: new Date(),
      theme: 'month-year-dropdown',
      keyboardInput: false,
    });

    // // Input validation
    const validate = () => {
      const $preferredNameEl = $('#preferredName')
      const preferredName = $preferredNameEl.val();

      if (!checkValidName(preferredName)) {
        setError($('#preferredName'), ERROR_INVALID_PREFERRED_NAME)
      } else {
        removeError($('#preferredName'))
      }

      return checkValidName(preferredName)
    }

    const validateAndDispatchData = () => {
      const $dobEl = $('#documentDateOfBirth')
      const selectedDate = $dobEl.val()
      const dob = moment(selectedDate, 'DD/MM/YYYY').toDate()
      const today = new Date()

      // Check date format validity
      if (!checkValidDateFormat(selectedDate)) {
        // If format not valid, remove from validated matrix
        setError($dobEl, ERROR_INVALID_DATE_FORMAT)
      } else {
        // If format valid, check if selected/typed date is before today's date
        // if (dob < today && calculateAge(dob) >= 14) { // selected day has to be before today
        if (dob < today) { // 2025-03-21 under 14 is now handled in the PD

          if (calculateAge(dob) >= 18 && totalAttempt == 0) {
            sendPageOpenAnalyticsEvent("birth-cert-age-verification-failed?")
            showSheet(
                  'Age verification failed',
                  [
                          'You must be 17 years or younger to use this ID document type. Please review your date of birth and try again',
                          'If you are 18 years or older, please choose a different ID document type to use instead.'
                  ],
                  { label: 'Close', onclick: closeSheet },
                  { label: 'Change ID document type', onclick: changeDocumentType },
                  { name: 'error', theme: 'danger' }
            )
            return
          }

          removeError($dobEl)
          dispatchData()
        } else {
          setError($dobEl, ERROR_DATE_MUST_BE_PAST)
        }
      }
    }

    function changeDocumentType() {
      sendUserInteractionAnalyticsEvent('eIDV|Change ID document type')
      closeSheet()
      dispatchBack()
    }
  </script>
</body>

</html>
